<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>AgroTetris</title>
<style type="text/css">
	*
	{
		margin: 0;
		padding: 0;
		border: none;
		background: rgba(0,0,0,0);
	}
	body, html
	{
		background: black;
		color: white;
		font-size: 2.2vh;
		font-family: Arial, Helvetica, sans-serif;
	}
	main
	{
		position: relative;
		min-height: 80vh;
		left: 50%;
		width: 50vh;
		margin-left: -25vh;
		margin-top: 8vh;
		margin-bottom: 25vh;
	}
	nav, footer
	{
		position: fixed;
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-around;
		align-items: center;
		align-content: center;
		width: 100%;
		height: 7vh;
		background: rgba(0,0,0,0.7);
	}
	nav
	{
		top: 0;
		border-bottom: solid 0.4vh #6B6B6B;
	}
	#hamburger, #showPlan
	{
		width: 5vh;
		height: 5vh;
	}
	#statistics
	{
		height: 5vh;
		width: 35vh;
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		justify-content: center;
		align-items: center;
		align-content: center;
		font-size: 2.5vh;
		font-weight: bold;
	}
	footer
	{
		bottom: 0;
		border-top: solid 0.4vh #6B6B6B;
	}
	.window
	{
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		max-width: 50vh;
		max-height: 90vh;
		overflow-x: hidden;
		overflow-y: scroll;
		scrollbar-width: none;
		-ms-overflow-style: none;
		border: solid 0.4vh #393939;
		background: #2F2F2F;
		box-shadow: 0 0 1.5vh 1vh black;
		display: flex;
		flex-direction: column;
		flex-wrap: nowrap;
		justify-content: space-between;
		align-items: center;
		align-content: center;
		gap: 2vh;
		padding: 1vh;
		padding-top: 1.5vh;
	}
	.window::-webkit-scrollbar
	{
		display: none;
	}
	.window .content
	{
		width: 100%;
		text-align: center;
	}
	.window button
	{
		height: 6vh;
		min-width: 7vh;
		padding: 0.5vh;
		padding-left: 5vh;
		padding-right: 5vh;
		border: none;
		border-radius: 3vh;
		background: black;
		color: white;
		font-size: 2.4vh;
	}
	#error
	{
		background: #2f0000;
		width: 45vh;
		height: 27vh;
		border-color: #750700;
	}
	#tutorial
	{
		background: #0761b1;
		width: 45vh;
		height: 27vh;
		border-color: #07256b;
	}
	#curtain
	{
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 47vh;
		height: 60vh;
		border: solid 0.4vh #4D4D4D;
		background: #1b1b1b;
		box-shadow: 0 0 5vh 10vh black;
		display: flex;
		flex-direction: column;
		flex-wrap: wrap;
		justify-content: center;
		gap: 3vh;
		align-items: center;
		align-content: center;
		padding: 1vh;
		padding-top: 1vh;
	}
	#curtain button
	{
		height: 6vh;
		min-width: 7vh;
		padding: 0.5vh;
		padding-left: 5vh;
		padding-right: 5vh;
		border: none;
		border-radius: 3vh;
		background: black;
		color: white;
		font-size: 2.4vh;
	}
	#placeName
	{
		width: 40vh;
		height: 5vh;
	}
	#placeName section
	{
		width: 100%;
		height: 100%;
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		justify-content: center;
		align-items: center;
		align-content: center;
		font-size: 2.5vh;
		font-weight: bold;
	}
	footer button
	{
		background: #6B6B6B;
		border: none;
		border-radius: 2.5vh;
		padding: 0.5vh;
		padding-left: 1vh;
		padding-right: 1vh;
		min-width: 6vh;
		height: 5vh;
		font-size: 2.5vh;
		font-weight: bold;
		color: black;
	}
	#rowPlace
	{
		position: relative;
		width: 100%;
		margin-bottom: 5vh;
	}
	#rowPlace section
	{
		position: relative;
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-around;
		align-items: center;
		align-content: center;
		width: 100%;
		height: auto;
		background: rgba(0,0,0,0);
	}
	#rowPlace .box
	{
		border-color: #cf7f00;
	}
	.row
	{
		position: relative;
		width: 100%;
	}
	.row section
	{
		position: relative;
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		justify-content: space-between;
		align-items: center;
		align-content: center;
		width: 100%;
		height: auto;
		background: rgba(0,0,0,0);
	}
	.box
	{
		position: relative;
		box-sizing: content-box;
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
		align-items: center;
		align-content: center;
		gap: 0.7vh;
		padding: 0.7vh;
		border: dashed 0.5vh #6B6B6B;
		min-height: 9vh;
		min-width: 6vh;
		max-width: 19.5vh;
		margin-top: 1vh;
		margin-bottom: 1vh;
	}
	.box.right
	{
		flex-direction: row-reverse;
	}
	.ghost
	{
		opacity: 0;
	}
	.ghost *
	{
		display: none;
	}
	.chest
	{
		position: relative;
		box-sizing: border-box;
		display: flex;
		flex-direction: column;
		flex-wrap: wrap;
		justify-content: center;
		align-items: center;
		align-content: center;
		height: 9vh;
		width: 6vh;
		font-size: 2vh;
		border-top: solid 1vh rgba(0,0,0,0.5);
		border-left: solid 1vh rgba(55,55,55,0.5);
		border-right: solid 1vh rgba(200,200,200,0.5);
		border-bottom: solid 1vh rgba(255,255,255,0.5);
		background: green;
		color: black;
		text-transform: uppercase;
	}
	.chest span
	{
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}
	.chest span:last-child
	{
		font-weight: bold;
	}
	#car .chest
	{
		height: 10.5vh;
		width: 7vh;
		font-size: 2.3vh;
	}
	#hand .chest
	{
		height: 12vh;
		width: 8vh;
		font-size: 2.65vh;
	}
	#car
	{
		position: relative;
		width: 42vh;
		height: 105vh;
		background: #1B1B1B;
		left: 50%;
		margin-left: -21vh;
		margin-top: 1vh;
	}
	#car section
	{
		position: relative;
		float: left;
		display: flex;
		flex-direction: column-reverse;
		flex-wrap: nowrap;
		justify-content: flex-start;
		align-items: center;
		align-content: center;
		width: 7vh;
		height: 100%;
		box-shadow: inset 0 0 0 0.4vh #1B1B1B, inset 0 0 0 0.9vh #111111;
	}
	#hand
	{
		position: fixed;
		box-sizing: content-box;
		bottom: 9vh;
		left: 1vh;
		padding: 1vh;
		border: dashed 0.5vh #6B6B6B;
		height: 12vh;
		width: 8vh;
		background: rgba(0,0,0,0.6);
		box-shadow: 0 0 0 1vh rgba(0,0,0,0.6);
	}
	.hidden
	{
		display: none !important;
	}
	#routes
	{
		width: 45vh;
		height: 65vh;
		background: #250039;
		border-color: #390057;
		justify-content: flex-start;
	}
	#routes span
	{
		font-size: 2.5vh;
		font-weight: bold;
		margin-bottom: 3vh;
	}
	#routes .content
	{
		width: 100%;
		height: auto;
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
		align-items: flex-start;
		align-content: flex-start;
	}
	#routes section
	{
		display: flex;
		flex-direction: column;
		flex-wrap: nowrap;
		justify-content: flex-start;
		align-items: center;
		align-content: center;
		margin-left: 1vh;
		margin-right: 1vh;
	}
	#routes .route
	{
		position: relative;
		box-sizing: border-box;
		display: flex;
		flex-direction: column;
		flex-wrap: nowrap;
		justify-content: center;
		align-items: center;
		align-content: flex-start;
		width: 12.5vh;
		height: 12.5vh;
		margin-top: 1vh;
		margin-bottom: 1vh;
		background: #f7cf00;
		border: solid 0.5vh black;
	}
	#routes .route svg
	{
		width: 100%;
	}
	#routes .route span
	{
		width: 100%;
		height: auto;
		margin-bottom: 0.5vh;
		font-size: 1.7vh;
		color: black;
	}
	#plan
	{
		width: 47vh;
		height: 50vh;
		background: #6B6B6B;
		border-color: #4d4d4d;
		color: black;
	}
	#plan .content
	{
		display: flex;
		justify-content: center;
		font-size: 2.1vh;
	}
	#plan table
	{
		border-collapse: collapse;
	}
	#plan td, #plan th
	{
		border: 0.3vh solid black;
		padding: 0.5vh
	}
	#finish
	{
		width: 45vh;
		height: 65vh;
		background: #390000;
		border-color: #6b0700;
		color: white;
	}
	#finish.complete
	{
		background: #2f3900;
		border-color: #576b00;
	}
	#finish .content
	{
		display: flex;
		flex-direction: column;
		flex-wrap: wrap;
		justify-content: flex-start;
		align-items: center;
		align-content: center;
		font-size: 2.1vh;
	}
	#finish table
	{
		border-collapse: collapse;
	}
	#finish td, #finish th
	{
		border: 0.3vh solid white;
		padding: 0.5vh
	}
	#finish span
	{
		display: block;
		font-size: 2.4vh;
		margin-bottom: 2vh;
	}
</style>
<script>
	const unlockedAll = false;
	const system =
	{
		load()
		{
			if (results.length === 0)
			{
				for (let i=0 ; i<system.routes.length ; i++)
				{
					results[i] = []
					for (let j=0 ; j<system.routes[i].length ; j++)
					{
						results[i][j] = {unlocked: false, data:[]}
					}
				}
			}
			if (localStorage.getItem('agro-tetris: situation'))
			{
				situation = JSON.parse(localStorage.getItem('agro-tetris: situation'))
			}
			else
			{
				showRoutes()
			}
			refreshStatistics()
			situation.click = 0
			situation.hand = 0
			situation.places = [{publisher:[]}]
			situation.commodity = []
			document.getElementsByTagName('footer')[0].getElementsByTagName('button')[0].onclick = next
			document.getElementById('showPlan').onclick = showPlan
			const divWin = document.getElementsByClassName('window')
			for (let div of divWin)
			{
				(div.getElementsByTagName('button')[0]||{}).onclick = system.close
			}
			el.main = document.getElementsByTagName('main')[0]
			el.hand = document.getElementById('hand')
			el.placeName = document.getElementById('placeName')
			el.places = []
			if (true)
			{
				el.rowPlace = document.createElement('div')
				el.rowPlace.id = 'rowPlace'
				const section = document.createElement('section')
				const box = document.createElement('div')
				box.className = 'box'
				el.places[0] = [box,0]
				section.appendChild(box)
				el.rowPlace.appendChild(section)
				el.main.appendChild(el.rowPlace)
			}
			const row = document.createElement('div')
			row.className = 'row'
			el.main.appendChild(row)
			el.cubby = [[0]]
			situation.cubby = [[0]]
			for (let s=0 ; s<2 ; s++)
			{
				const section = document.createElement('section')
				for (let b=0 ; b<2 ; b++)
				{
					const nr = 1+(s*2)+b
					const box = document.createElement('div')
					box.className = `box ${['left','right'][b]}`
					box.dataset.place = `cubby`
					box.dataset.type = `0`
					box.dataset.nr = `${nr}`
					el.cubby[0][nr] = box
					situation.cubby[0][nr] = []
					box.onclick = click.box
					section.appendChild(box)
				}
				row.appendChild(section)
			}
			situation.car = [[0]]
			el.car = [[0]]
			if (true)
			{
				const car = document.createElement('div')
				car.id = 'car'
				for (let s=0 ; s<6 ; s++)
				{
					const nr = s+1
					const section = document.createElement('section')
					section.dataset.place = `car`
					section.dataset.type = `0`
					section.dataset.nr = `${nr}`
					el.car[0][nr] = section
					situation.car[0][nr] = []
					section.onclick = click.box
					car.appendChild(section)
				}
				row.appendChild(car)
			}
		},
		newRoutes: function(lvl)
		{
			document.getElementById('routes').classList.add('hidden')
			const route = system.routes[lvl[0]][lvl[1]]
			situation.time = [[]]
			situation.moves = [0]
			situation.points = 0
			situation.dam = route.dam
			situation.required = route.required
			situation.lvl = [lvl[0],lvl[1]]
			situation.lvlName = route.name
			situation.place = 0
			situation.hand = 0
			situation.commodity = []
			situation.places = []
			situation.namePlaces = []
			situation.places[0] = [[],[]]
			situation.namePlaces[0] = {name: 'Załadunek', short:'ZŁD', chicken:0, meat:0, smoke:0}
			situation.tutorial = []
			let column = 0
			for (const shop of route.shops)
			{
				const placeNameRow = {name:shop.name, short:shop.short.toUpperCase(), chicken:0, meat:0, smoke:0}
				situation.time.push([])
				situation.moves.push(0)
				for (let i=0 ; i<3 ; i++)
				{
					let values = shop.commodity[i]
					if (!Array.isArray(values))
					{
						values = [values]
					}
					for (let j=0 ; j<values.length ; j++)
					{
						if (values[j] > 0)
						{
							column ++
							placeNameRow[['chicken','meat','smoke'][i]] += values[j]
							const chest = {content: true}
							chest.type = ['chicken','meat','smoke'][i]
							chest.value = values[j]
							chest.shop = shop.name
							chest.short = shop.short
							situation.commodity.push(chest)
						}
					}
				}
				const place = [[],[]]
				for (let i=0 ; i<3 ; i++)
				{
					let values = shop.empty[i]
					if (!Array.isArray(values))
					{
						values = [values]
					}
					for (let j=0 ; j<values.length ; j++)
					{
						if (values[j] > 0)
						{
							const chest = {content: false}
							chest.type = ['chicken','meat','smoke'][i]
							chest.value = values[j]
							place[0].push(chest)
						}
					}
				}
				situation.places.push(place)
				situation.namePlaces.push(placeNameRow)
			}
			if (column > 60)
			{
				debugger
			}
			click.publisher()
			system.refresh()
			curtain.open()
		},
		refresh: function()
		{
			for (let i=1 ; i<situation.cubby[0].length ; i++)
			{
				refreshBox(situation.cubby[0][i],el.cubby[0][i])
			}
			for (let i=1 ; i<situation.car[0].length ; i++)
			{
				refreshBox(situation.car[0][i],el.car[0][i])
			}
			el.placeName.innerHTML = ''
			for (let i=0 ; i<situation.namePlaces.length ; i++)
			{
				const section = document.createElement('section')
				section.innerHTML = situation.namePlaces[i].name
				if (i != situation.place)
				{
					section.classList.add('hidden')
				}
				el.placeName.appendChild(section)
			}
			el.rowPlace.innerHTML = ''
			el.places = []
			for (let i=0 ; i<situation.places.length ; i++)
			{
				const section = document.createElement('section')
				if (i === 0)
				{
					const box = document.createElement('div')
					box.className = 'box'
					el.places[0] = [box,0]
					box.onclick = click.publisher
					section.appendChild(box)
					refreshBox(situation.places[0][0],box)
				}
				else
				{
					el.places[i] = []
					for (let j=0 ; j<2 ; j++)
					{
						const box = document.createElement('div')
						box.className = 'box'
						el.places[i][j] = box
						box.dataset.place = `places`
						box.dataset.type = `${i}`
						box.dataset.nr = `${j}`
						box.onclick = click.box
						section.appendChild(box)
						refreshBox(situation.places[i][j],box)
					}
				}
				if (i != situation.place)
				{
					section.classList.add('hidden')
				}
				el.rowPlace.appendChild(section)
			}
		},
		routes:
		[
			[
				{
					name: "Samouczek",
					required: 7,
					dam: 2,
					shops:
					[
						{
							name: "Kłoda",
							short: "KŁD",
							commodity: [10,10,10],
							empty: [10,10,10],
						},
						{
							name: "Rydzyna",
							short: "RDZ",
							commodity: [10,10,10],
							empty: [10,10,10],
						},
						{
							name: "Bojanowo",
							short: "BJN",
							commodity: [10,10,10],
							empty: [7,7,7],
						},
						{
							name: "Golina W",
							short: "GOL",
							commodity: [10,10,10],
							empty: [3,3,3],
						},
						{
							name: "Czernina",
							short: "CZR",
							commodity: [10,10,10],
							empty: [10,10,10],
						},
						{
							name: "Witaszyce",
							short: "WIT",
							commodity: [10,10,10],
							empty: [10,10,10],
						},
						{
							name: "Góra 4",
							short: "GR4",
							commodity: [10,10,6],
							empty: [8,8,8],
						},
						{
							name: "Góra 1",
							short: "GR1",
							commodity: [10,10,6],
							empty: [2,2,2],
						},
						{
							name: "Góra 3",
							short: "GR3",
							commodity: [10,10,6],
							empty: [10,10,10],
						},
						{
							name: "Góra 5",
							short: "GR5",
							commodity: [10,10,6],
							empty: [10,10,10],
						},
						{
							name: "Góra 2",
							short: "GR2",
							commodity: [10,10,6],
							empty: [5,5,5],
						},
						{
							name: "Niechlów",
							short: "NCH",
							commodity: [10,10,6],
							empty: [5,5,5],
						},
					]
				},
				{
					name: "Nowa Sól",
					required: 7,
					dam: 2,
					shops:
					[
						{
							name: "Jerzmanowa",
							short: "JEZ",
							commodity: [7,[6,7],5],
							empty: [8,6,5],
						},
						{
							name: "Nielubia",
							short: "NLB",
							commodity: [8,[7,7],6],
							empty: [8,[6,6],5],
						},
						{
							name: "Bytom odrzański 1",
							short: "BT1",
							commodity: [5,6,4],
							empty: [7,4,3],
						},
						{
							name: "Bytom odrzański 2",
							short: "BT2",
							commodity: [5,7,4],
							empty: [7,8,3],
						},
						{
							name: "Nowa Sól 1",
							short: "NS1",
							commodity: [5,7,4],
							empty: [4,8,5],
						},
						{
							name: "Nowa Sól 2",
							short: "NS2",
							commodity: [5,6,4],
							empty: [7,7,3],
						},
						{
							name: "Nowa Sól 3",
							short: "NS3",
							commodity: [6,[5,7],6],
							empty: [[7,7],[6,6],5],
						},
						{
							name: "Nowa Sól 4",
							short: "NS4",
							commodity: [7,[5,6],5],
							empty: [8,10,6],
						},
						{
							name: "Modrzyca",
							short: "MDZ",
							commodity: [6,[5,7],6],
							empty: [[7,7],[6,6],5],
						},
						{
							name: "Otyń",
							short: "OTN",
							commodity: [6,7,4],
							empty: [3,5,3],
						},
						{
							name: "Przyborów",
							short: "PBR",
							commodity: [5,6,3],
							empty: [7,8,4],
						},
						{
							name: "Siedlisko",
							short: "SDL",
							commodity: [6,[6,7],6],
							empty: [[7,8],[5,6],5],
						},
					]
				}
			],
			[
				{
					name: "Góry",
					required: 7,
					dam: 2,
					shops:
					[
						{
							name: "Kłoda",
							short: "KŁD",
							commodity: [4,6,4],
							empty: [5,7,4],
						},
						{
							name: "Rydzyna",
							short: "RDZ",
							commodity: [5,6,4],
							empty: [7,7,3],
						},
						{
							name: "Bojanowo",
							short: "BJN",
							commodity: [7,[6,8],5],
							empty: [8,10,5],
						},
						{
							name: "Golina W",
							short: "GOL",
							commodity: [5,7,4],
							empty: [7,8,3],
						},
						{
							name: "Czernina",
							short: "CZR",
							commodity: [5,7,4],
							empty: [4,8,5],
						},
						{
							name: "Witaszyce",
							short: "WIT",
							commodity: [5,6,4],
							empty: [7,7,3],
						},
						{
							name: "Góra 4",
							short: "GR4",
							commodity: [5,7,4],
							empty: [7,8,3],
						},
						{
							name: "Góra 1",
							short: "GR1",
							commodity: [7,[5,7],6],
							empty: [8,[6,6],5],
						},
						{
							name: "Góra 3",
							short: "GR3",
							commodity: [5,6,4],
							empty: [7,7,3],
						},
						{
							name: "Góra 5",
							short: "GR5",
							commodity: [6,7,4],
							empty: [3,5,3],
						},
						{
							name: "Góra 2",
							short: "GR2",
							commodity: [5,6,3],
							empty: [7,8,4],
						},
						{
							name: "Niechlów",
							short: "NCH",
							commodity: [5,7,4],
							empty: [7,9,3],
						},
					]
				}
			],
			[
				{
					name: "Poniec",
					required: 7,
					dam: 2,
					shops:
					[
						{
							name: "Poniec 2",
							short: "PN2",
							commodity: [5,[6,5],4],
							empty: [[6,7],[7,7],5],
						},
						{
							name: "Poniec 1",
							short: "PN1",
							commodity: [4,6,4],
							empty: [5,7,4],
						},
						{
							name: "Pudliszki",
							short: "PDL",
							commodity: [7,7,4],
							empty: [7,9,4],
						},
						{
							name: "Krobia 1",
							short: "KR1",
							commodity: [[5,6],[6,5],7],
							empty: [[7,7],[7,7],9],
						},
						{
							name: "Krobia 2",
							short: "KR2",
							commodity: [[5,6],[7,5],8],
							empty: [[7,6],[5,7],8],
						},
						{
							name: "Pępowo 2",
							short: "PP2",
							commodity: [7,7,4],
							empty: [7,9,4],
						},
						{
							name: "Pępowo 1",
							short: "PP1",
							commodity: [[5,6],[6,5],6],
							empty: [[7,7],[5,7],9],
						},
						{
							name: "Skoraszewice",
							short: "SKR",
							commodity: [4,6,2],
							empty: [3,5,4],
						},
						{
							name: "Niepart",
							short: "NPR",
							commodity: [7,7,4],
							empty: [7,9,4],
						},
						{
							name: "Konary",
							short: "KNR",
							commodity: [4,6,4],
							empty: [5,7,4],
						},
						{
							name: "Miejska Górka",
							short: "MGR",
							commodity: [[5,7],[7,6],8],
							empty: [[7,6],[7,7],8],
						},
						{
							name: "Sarnowa",
							short: "SAR",
							commodity: [4,6,4],
							empty: [5,7,4],
						},
					]
				}
			]
		],
		colors:
		{
			chicken: 0,
			meat: 50,
			smoke: 220,
			dam: 80,
		},
		close: function(event)
		{
			const parent = event.target.parentElement;
			parent.classList.add('hidden');
		}
	}
	const results = JSON.parse(localStorage.getItem('agro-tetris: results')||'[]')
	let situation = {};
	const el = {};
	const click =
	{
		publisher: function()
		{
			const list = situation.places[0][0]
			if (!hand.value())
			{
				if (list.length > 0)
				{
					hand.add(list.pop())
				}
				if (situation.commodity.length > 0)
				{
					const nr = Math.floor(Math.random()*situation.commodity.length)
					const chest = situation.commodity.splice(nr,1)[0]
					list.push(chest)
				}
				else if (situation.dam > 0)
				{
					list.push({content:false,type:'dam',value:10})
					showTutorial('Zielony klocek to tyczka. Tyczka nie może się przewrócić. Użyj jej do zabezpieczenia towaru.',4)
					situation.dam--
				}
			}
			refreshBox(list,el.places[0][0])
		},
		box: async function(event)
		{
			const chestIndex = (Number(event.target.dataset.index)||0)
			const t = event.currentTarget
			const element = el[t.dataset.place][Number(t.dataset.type)][Number(t.dataset.nr)]
			const list = situation[t.dataset.place][Number(t.dataset.type)][Number(t.dataset.nr)]
			const maxValue = {cubby:3,car:10,places:9}[t.dataset.place]
			//
			situation.click++
			await new Promise(resolve => setTimeout(resolve, 200));
			let double = false
			if (situation.click < 1)
			{
				return
			}
			if (situation.click == 2)
			{
				double = true
			}
			situation.click = 0
			//
			if (chestIndex)
			{
				if (double)
				{
					if (hand.disconnect(list,chestIndex-1,element))
					{
						(situation.moves||[])[situation.place] += 1
						return
					}
				}
				else if (hand.connect(list,chestIndex-1,element))
				{
					(situation.moves||[])[situation.place] += 2
					return
				}
			}
			if (list.length < maxValue)
			{
				if (hand.value())
				{
					if (hand.value().value < 10)
					{
						showTutorial('Towar musisz ustawiać tak żeby nie było dużych różnic wysokości.',2)
					}
					else
					{
						showTutorial('Ruchy liczą się inaczej dla pustych i pełnych klocków. Przesunięcie pełnego klocka dodaje 4 do liczby ruchów',3)
					}
					if (hand.value().content)
					{
						(situation.moves||[])[situation.place] += 4
					}
					else
					{
						(situation.moves||[])[situation.place] += 3
					}
					list.push(hand.grab())
					refreshBox(list,element)
				}
				else
				{
					hand.add(list.pop())
					refreshBox(list,element)
				}
			}
			else
			{
				if (!hand.value())
				{
					hand.add(list.pop())
					refreshBox(list,element)
					showTutorial('Do góry po prawej jest przycisk pokazujacy rozpiskę trasy. Przyda się żeby dobrze ułożyć towar.',8)
				}
				else
				{
					showTutorial('Pola mają ograniczoną pojemność. Towar można z nich wyciągać w kolejności odwrotnej niż był wkładany.',9)
				}
			}
		},
	}
	function next()
	{
		if (hand.value())
		{
			return info('Żeby przejść dalej musisz upuścić trzymany klocek.')
		}
		for (let i=1 ; i<situation.cubby[0].length ; i++)
		{
			if (situation.cubby[0][i].length > 0)
			{
				return info('Nie możesz przejść dalej jeżeli masz klocki w schowku.')
			}
		}
		for (let r=1 ; r<situation.car[0].length ; r++)
		{
			for (let i=0 ; i<situation.car[0][r].length ; i++)
			{
				const chest = ((situation.car[0][r]||[])[i]||{})
				if ((chest.value||0) > 0 && chest.type != 'dam')
				{
					if (i > 0)
					{
						const neighbor = ((situation.car[0][r]||[])[(i-1)]||{})
						if ((neighbor.value||0)+4 < chest.value||0)
						{
							if (chest.short)
							{
								return info(`Słupek klocków (${chest.short} ${chest.value}) na samochodzie nie ma podparcia z przodu.`)
							}
							else
							{
								return info(`Słupek klocków na samochodzie nie ma podparcia z przodu.`)
							}
						}
					}
					if (r > 1)
					{
						const neighbor = ((situation.car[0][r-1]||[])[i]||{})
						if ((neighbor.value||0)+3 < chest.value||0)
						{
							if (chest.short)
							{
								return info(`Na samochodzie są różnice w wysokości klocków większe niż 3.<br>(${chest.short} ${chest.value})`)
							}
							else
							{
								return info(`Na samochodzie są różnice w wysokości klocków większe niż 3.`)
							}
						}
					}
					if (r < 6)
					{
						const neighbor = ((situation.car[0][r+1]||[])[i]||{})
						if ((neighbor.value||0)+3 < chest.value||0)
						{
							if (chest.short)
							{
								return info(`Na samochodzie są różnice w wysokości klocków większe niż 3.<br>(${chest.short} ${chest.value})`)
							}
							else
							{
								return info(`Na samochodzie są różnice w wysokości klocków większe niż 3.`)
							}
						}
					}
				}
			}
		}
		if (situation.place === 0)
		{
			if (situation.commodity.length > 0)
			{
				return info('Żeby zakończyć załadunek musisz załadować wszystkie klocki.')
			}
		}
		else
		{
			for (let r=0 ; r<2 ; r++)
			{
				const boxes = situation.places[situation.place][r]
				for (let i=0 ; i<boxes.length ; i++)
				{
					if (!boxes[i].content)
					{
						return info('Żeby przejść dalej zabierz puste klocki.')
					}
					if (boxes[i].shop != situation.namePlaces[situation.place].name)
					{
						return info('Zostawiłeś niewłaściwe klocki!')
					}
				}
			}
			for (let r=1 ; r<situation.car[0].length ; r++)
			{
				for (let i=0 ; i<situation.car[0][r].length ; i++)
				{
					const chest = ((situation.car[0][r]||[])[i]||{})
					if (chest.shop === situation.namePlaces[situation.place].name)
					{
						return info('Nie zostawiłeś całego towaru!')
					}
				}
			}
		}
		if (situation.places[situation.place+1])
		{
			situation.time[situation.place][1] = Date.now()
			situation.place++
			for (let i=0 ; i<el.placeName.children.length ; i++)
			{
				const element = el.placeName.children[i]
				if (i === situation.place)
				{
					element.classList.remove('hidden')
				}
				else
				{
					element.classList.add('hidden')
				}
			}
			for (let i=0 ; i<el.rowPlace.children.length ; i++)
			{
				const element = el.rowPlace.children[i]
				if (i === situation.place)
				{
					element.classList.remove('hidden')
				}
				else
				{
					element.classList.add('hidden')
				}
			}
			curtain.open()
			//localStorage.setItem('agro-tetris: situation',JSON.stringify(situation))
		}
		else
		{
			situation.time[situation.place][1] = Date.now()
			finish()
		}
	}
	const hand =
	{
		value: function()
		{
			const giveBack = JSON.parse(JSON.stringify(situation.hand))
			return giveBack
		},
		grab: function()
		{
			const giveBack = JSON.parse(JSON.stringify(situation.hand))
			situation.hand = 0
			hand.refresh()
			return giveBack
		},
		add: function(chestData)
		{
			if (!chestData){return}
			const giveBack = JSON.parse(JSON.stringify(situation.hand))
			if (giveBack)
			{
				return false
			}
			situation.hand = JSON.parse(JSON.stringify(chestData))
			hand.refresh()
			return true
		},
		connect: function(list,index,box)
		{
			const chestData = list[index]
			if (!chestData){return false}
			if (situation.hand.content || chestData.content){return false}
			if (situation.hand.type != chestData.type){return false}
			if (index > list.length-3)
			if (situation.hand.value + chestData.value <= 10)
			{
				chestData.value += situation.hand.value
				situation.hand = 0
			}
			else
			{
				situation.hand.value -= (10-chestData.value)
				chestData.value = 10
			}
			hand.refresh()
			refreshBox(list,box)
			return true
		},
		disconnect: function(list,index,box)
		{
			const chestData = list[index]
			if (!chestData){return false}
			if (situation.hand)
			{
				if (situation.hand.content || chestData.content){return false}
				if (situation.hand.type != chestData.type){return false}
			}
			if (index > list.length-3)
			if (!situation.hand)
			{
				situation.hand = {content:false,type:chestData.type,value:0}
			}
			if (situation.hand.value < 10)
			{
				chestData.value --
				situation.hand.value ++
				if (chestData.value < 1)
				{
					list.splice(index,1)
				}
				hand.refresh()
				refreshBox(list,box)
				return true
			}
			return false
		},
		refresh()
		{
			el.hand.innerHTML = ''
			if (situation.hand)
			{
				const chest = createChest(situation.hand)
				el.hand.appendChild(chest)
			}
		},
		reset: function()
		{
			situation.hand.dataset.chest = '0'
			el.hand.innerHTML = ''
		}
	}
	function createChest(data)
	{
		const chest = document.createElement('div')
		chest.className = 'chest'
		if (data.type === "dam")
		{
			chest.style.background = `#437500`
		}
		else if (data.content)
		{
			chest.style.background = `hsl(${system.colors[data.type]},100%,55%)`
			chest.innerHTML = `<span>${data.short}</span><span>${data.value}</span>`
		}
		else
		{
			chest.style.background = `hsl(${system.colors[data.type]},80%,65%)`
			chest.innerHTML = `<span>${data.value}</span>`
		}
		return chest
	}
	function refreshBox(list,element)
	{
		if (!Array.isArray(list))
		{
			debugger
		}
		element.innerHTML = ''
		for (let i=0 ; i<list.length ; i++)
		{
			const chest = createChest(list[i])
			chest.dataset.index = `${i+1}`
			for (let j=0 ; j<chest.children.length ; j++)
			{
				chest.children[j].dataset.index = `${i+1}`
			}
			element.appendChild(chest)
		}
	}
	function info(text)
	{
		const frame = document.getElementById('error')
		frame.getElementsByClassName('content')[0].innerHTML = text
		frame.classList.remove('hidden')
	}
	const curtain =
	{
		open: function()
		{
			const div = document.getElementById('curtain')
			div.getElementsByTagName('button')[0].onclick = curtain.close
			div.classList.remove('hidden')
		},
		close: function()
		{
			situation.time[situation.place][0] = Date.now()
			const div = document.getElementById('curtain')
			div.classList.add('hidden')
			if (situation.place == 0)
			{
				showTutorial('Na ekranie zobaczysz pakę ciężarówki podzieloną na 6 kolumn. Wyżej są schowki i miejsce wydawania towaru. Towar jest podawany losowo. Ułuż go na pace w odpowiedniej kolejności klikając na miejsce skąd chcesz wziąć klocek a później w miejscu gdzie chcesz go upuścić.',1)
			}
			else if (situation.place == 1)
			{
				showTutorial('Podczas rozładunku musisz zostawić odpowiednie klocki i zabrać puste',5)
			}
			else if (situation.place == 4)
			{
				showTutorial('Puste klocki można łączyć. Kliknij na pusty klocek tego samego rodzaju. Utworzy się bloczek o wysokości 10.',6)
			}
			else if (situation.place == 5)
			{
				showTutorial('Puste klocki można też rozłączyć klikając podwójnie.',7)
			}
		}
	}
	function refreshStatistics()
	{
		const start = ((situation.time||[])[situation.place]||[])[0]||0
		const moves = (situation.moves||[])[situation.place]
		let time = 0
		if (start)
		{
			time = Math.round((Date.now()-start)/1000)
		}
		document.getElementById('statistics').innerHTML = `Czas: ${time||0}s. &nbsp; Ruchy: ${moves||0}`
		setTimeout(refreshStatistics,1000)
	}
	function showRoutes()
	{
		const routes = document.getElementById('routes')
		const content = routes.getElementsByClassName('content')[0]
		routes.classList.remove('hidden')
		content.innerHTML = ''
		for (let i=0 ; i<system.routes.length ; i++)
		{
			const section = document.createElement('section')
			for (let j=0 ; j<system.routes[i].length ; j++)
			{
				const name = system.routes[i][j].name
				const unlocked = ((results[i]||[])[j]||{}).unlocked
				const route = document.createElement('div')
				route.className = 'route'
				if (unlocked || j===0 || unlockedAll)
				{
					const span = document.createElement('span')
					span.innerHTML = name
					route.appendChild(span)
					route.onclick = ()=>{system.newRoutes([i,j])}
				}
				else
				{
					route.innerHTML = `<svg viewBox="0 0 16 16"><path d="M8 1C3 1 3 7 3 7H2v8h12V7h-1s0-6-5-6zm0 2c3 0 3 4 3 4H5s0-4 3-4z" style="fill:black; stroke:none; stroke-width:4"></path>
					</svg>`
				}
				section.appendChild(route)
			}
			content.appendChild(section)
		}
	}
	function showPlan()
	{
		if (!document.getElementById('plan').classList.contains('hidden'))
		{
			document.getElementById('plan').classList.add('hidden')
		}
		else
		{
			const content = document.getElementById('plan').getElementsByClassName('content')[0]
			content.innerHTML = ''
			const data = situation.namePlaces
			if (!data){return}
			const table = document.createElement('table')
			if (true)
			{
				const tr = document.createElement('tr')
				for (let j=0 ; j<5 ; j++)
				{
					const th = document.createElement('th')
					th.innerHTML = ['','-- Sklep --','- D -','- M -','- W -','- X -'][j]
					tr.appendChild(th)
				}
				table.appendChild(tr)
			}
			for (let i=1 ; i<data.length ; i++)
			{
				const tr = document.createElement('tr')
				for (let j=0 ; j<5 ; j++)
				{
					const td = document.createElement('td')
					td.innerHTML = data[i][['short','name','chicken','meat','smoke','short'][j]]
					tr.appendChild(td)
				}
				table.appendChild(tr)
			}
			content.appendChild(table)
			document.getElementById('plan').classList.remove('hidden')
		}
	}
	function showTutorial(text,nr)
	{
		if (situation.tutorial[nr]){return}
		situation.tutorial[nr] = true
		if (situation.lvl[0] === 0 && situation.lvl[1] === 0)
		{
			const frame = document.getElementById('tutorial')
			frame.getElementsByClassName('content')[0].innerHTML = text
			frame.classList.remove('hidden')
		}
	}
	function finish()
	{
		const div = document.getElementById('finish')
		const content = div.getElementsByClassName('content')[0]
		content.innerHTML = ''
		const data = []
		const total = [0,0]
		for (let i=0 ;  i<situation.namePlaces.length ; i ++)
		{
			data[i] = {name:situation.namePlaces[i].name}
		}
		for (let i=0 ;  i<situation.time.length ; i ++)
		{
			data[i].time = 0
			if (situation.time[i][0])
			{
				data[i].time = Math.round(((situation.time[i][1]||situation.time[i][0])-situation.time[i][0])/1000)
			}
			total[0] += data[i].time
		}
		for (let i=0 ;  i<situation.moves.length ; i ++)
		{
			data[i].moves = situation.moves[i]
			total[1] += data[i].moves
		}
		results[situation.lvl[0]][situation.lvl[1]].data.push(total)
		if (situation.required > total[0])
		{
			div.classList.add('complete')
			if (results[situation.lvl[0]][situation.lvl[1]+1])
			{
				results[situation.lvl[0]][situation.lvl[1]+1].unlocked = true
			}
		}
		else
		{
			div.classList.remove('complete')
		}
		data.push({name:'podsumowanie',time:total[0],moves:total[1]})
		const table = document.createElement('table')
		const span = document.createElement('span')
		if (situation.required > total[0])
		{
			span.innerHTML = `Poziom ${situation.lvlName} ukończony.<br>`
		}
		else
		{
			span.innerHTML = `Poziom ${situation.lvlName} nie ukończony.<br>`
		}
		span.innerHTML += `Czas: ${total[0]}s &nbsp; Kroki: ${total[1]}`
		if (true)
		{
			const tr = document.createElement('tr')
			for (let j=0 ; j<3 ; j++)
			{
				const th = document.createElement('th')
				th.innerHTML = ['- - Punkt - -','- Czas -','- kroki -'][j]
				tr.appendChild(th)
			}
			table.appendChild(tr)
		}
		for (let i=0 ; i<data.length ; i++)
		{
			const tr = document.createElement('tr')
			for (let j=0 ; j<3 ; j++)
			{
				const td = document.createElement('td')
				td.innerHTML = data[i][['name','time','moves'][j]]+['','s',''][j]
				tr.appendChild(td)
			}
			table.appendChild(tr)
		}
		content.appendChild(span)
		content.appendChild(table)
		div.classList.remove('hidden')
		showRoutes()
	}
</script>
</head>
<body onload="system.load()">
	<main></main>
	<div id="hand"></div>
	<nav>
		<svg id="hamburger" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" data-path="menu">
			<polygon fill="white" points="0,0 0,20 100,20 100,0"></polygon>
			<polygon fill="white" points="0,40 0,60 100,60 100,40"></polygon>
			<polygon fill="white" points="0,80 0,100 100,100 100,80"></polygon>
		</svg>
		<div id="statistics"></div>
		<svg id="showPlan" viewBox="0 0 22 22" stroke="white" stroke-width="2">
			<rect height="20" width="20" y="1" x="1"></rect>
			<line x1="4" y1="6" x2="18" y2="6" />
			<line x1="4" y1="11" x2="18" y2="11" />
			<line x1="4" y1="16" x2="15" y2="16" />
		</svg>
	</nav>
	<footer>
		<div id="placeName">
		</div>
		<button>Dalej</button>
	</footer>
	<div class="window hidden" id="plan">
		<div class="content"></div>
		<button>OK</button>
	</div>
	<div class="window hidden" id="error">
		<div class="content"></div>
		<button>OK</button>
	</div>
	<div class="window hidden" id="tutorial">
		<div class="content"></div>
		<button>OK</button>
	</div>
	<div class="window hidden" id="curtain">
		<div class="content">Kliknij guzik gdy będziesz gotowy.</div>
		<button>Gotowy</button>
	</div>
	<div class="window hidden" id="routes">
		<span>Wybierz trasę</span>
		<div class="content"></div>
	</div>
	<div class="window hidden" id="finish">
		<div class="content"></div>
		<button>OK</button>
	</div>
</body>
</html>
